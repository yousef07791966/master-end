<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


        <!-- Google Web Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"> 



        <!-- Libraries Stylesheet -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
        <link href="lib/animate/animate.min.css" rel="stylesheet">
        <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
        <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet">


    
      <!-- Favicon -->
      <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.ico">
    
      <!-- CSS 
      ========================= -->
      <!--bootstrap min css-->
      <link rel="stylesheet" href="assets/css/bootstrap.min.css">
      <!--owl carousel min css-->
      <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
      <!--slick min css-->
      <link rel="stylesheet" href="assets/css/slick.css">
      <!--magnific popup min css-->
      <link rel="stylesheet" href="assets/css/magnific-popup.css">
      <!--font awesome css-->
      <link rel="stylesheet" href="assets/css/font.awesome.css">
      <!--ionicons min css-->
      <link rel="stylesheet" href="assets/css/ionicons.min.css">
      <!--animate css-->
      <link rel="stylesheet" href="assets/css/animate.css">
      <!--jquery ui min css-->
      <link rel="stylesheet" href="assets/css/jquery-ui.min.css">
      <!--slinky menu css-->
      <link rel="stylesheet" href="assets/css/slinky.menu.css">
      <!--plugins css-->
      <link rel="stylesheet" href="assets/css/plugins.css">
      
      <!-- Main Style CSS -->
      <link rel="stylesheet" href="assets/css/style.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      <!--modernizr min js here-->
      <script src="assets/js/vendor/modernizr-3.7.1.min.js"></script>
          <!-- Customized Bootstrap Stylesheet -->
          <link href="css/bootstrap.min.css" rel="stylesheet">

          <link href="css/style.css" rel="stylesheet">
</head>
<body>
          <!-- Navbar & Hero Start -->
          <div class="container-fluid sticky-top px-0" style="direction: rtl;">
            <nav class="navbar navbar-expand-lg navbar-dark bg-light py-3 px-4">
                <a href="index.html" class="navbar-brand p-0">
                </a>
                <div class="logo">
                    <img src="logo/quds.png" alt="">
                </div>
                
                <a href="index.html" class="text-secondary display-6">القدس  </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto pt-2 pt-lg-0">
                        <a href="index.html" class="nav-item nav-link">الصفحة الرئيسية</a>

                        <div  class="nav-item dropdown" >
                            <a style="color: #fff !important ;" href="#" class="nav-link dropdown-toggle text-dark" data-bs-toggle="dropdown">المنتجات </a>
                            <div class="dropdown-menu m-lg-0" id="category">
                            
                            </div>
                        </div>
                        <a href="about.html" class="nav-item nav-link">من نحن</a>
                        <a href="contact.html" class="nav-item nav-link">تواصل معنا</a>
                        <a href="register.html" class="nav-item nav-link">إنشاء حساب</a>
                        
                        <a href="register.html" id="logout" class="nav-item nav-link">تسجيل الخروج</a>

                      </div>
                      <div class="d-flex align-items-center flex-nowrap pt-3  pt-lg-0 ms-lg-2">
                          <!-- <button class="btn btn-primary py-2 px-3" data-bs-toggle="modal" data-bs-target="#searchModal"><i class="fas fa-search"></i></button> -->
                          <!-- <a href="#" class="btn btn-secondary py-2 px-4 ms-3 flex-wrap flex-sm-shrink-0">Get a Quate</a> -->
                       <hr style="padding: 4px;">  <br> <a href="cart.html"class="btn btn-primary py-2 px-3"><i class="fa fa-shopping-cart ms-2"></i></a></a>
                      </div>
                   
  
                  </div>
              </nav>
          </div>

   

      <!-- my account start  -->
    <section class="main_content_area">
      <div class="container">
        <div class="account_dashboard">
          <div class="row">
            <div class="col-sm-12 col-md-3 col-lg-3">
              <!-- Nav tabs -->
              <div class="dashboard_tab_button">
                <ul role="tablist" class="nav flex-column dashboard-list">
                  <li>
                    <a href="#" data-bs-toggle="tab" class="nav-link active"
                      >Dashboard</a
                    >
                  </li>
                  <li>
                    <a href="#orders" data-bs-toggle="tab" class="nav-link "    onclick="getOrdersbyUserId()"
                      >Orders</a
                    >
                  </li>
                
                 
                  <li onclick="removeOrderTable()">
                    <a
                      href="#account-details"
                      data-bs-toggle="tab"
                      class="nav-link"
                      >Account details</a
                    >
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-sm-12 col-md-9 col-lg-9">
              <!-- Tab panes -->
              <div class="tab-content dashboard_content">
                <div class="tab-pane fade show active" id="dashboard">
              
                </div>
                <div class="tab-pane fade" id="orders">
                  <h3>Orders</h3>
                  <div class="table-responsive">
                    <table class="table">
                      <thead>
                        <tr>
                          <th> Product Name</th>
                          <th>Price </th>
                          <th>Price With Discount</th>
                          <th>quantity</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="containerorders">
                      
                      </tbody>
                    </table>
                  </div>
                </div>
                </div>
                <div class="tab-pane fade" id="downloads">
                  <h3>Downloads</h3>
                  <div class="table-responsive">
                    <table class="table" >
                      <thead>
                        <tr>
                          <th>Product</th>
                          <th>Price</th>
                          <th>Brand</th>
                          <th>Quantity</th>
                          <th>Download</th>
                        </tr>
                      </thead>
                      <tbody id="downloadsTable">
                        
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="account-details">
                  <h3>Account details</h3>
                  <div class="login">
                    <div class="login_form_container">
                      <div class="account_login_form">
                        <form id="">
                          <br />
                          <label>Full Name</label>
                          <input type="text" name="Name" id="name" /><br/>
                      
                          <label>Email</label>
                          <input type="email" name="Email" id="email" disabled /><br/>
                      
                          <label>Your Address</label>
                          <input type="text" name="Address" id="addrress" /><br/>
                      
                          <label>Phone Number</label>
                          <input type="text" name="PhoneNumber" id="phone-number" /><br/>
                      
                          <br />
                          <div class="save_button primary_btn default_button">
                            <button type="button" class="btn btn-danger" onclick="submitEditProfile()">
                              Save
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- my account end   -->
<!-- Footer Start -->
<div class="container-fluid footer py-5 wow fadeIn" data-wow-delay="0.2s">
    <div class="container py-5">
        <div class="row g-5">
            <div class="col-md-6 col-lg-6 col-xl-3">
                <div class="footer-item d-flex flex-column">
                    
                  
                </div>
            </div>
            <div class="col-md-6 col-lg-6 col-xl-3">
                <div class="footer-item d-flex flex-column">
                    <h4 class="text-white mb-4"></h4>
                    <a href="index.html"><i class="fas fa-angle-right me-2"></i> الصفحة الرئيسية</a>
                  
                    <a href="about.html"><i class="fas fa-angle-right me-2"></i> من نحن</a>
                  
                    <a href="contact.html"><i class="fas fa-angle-right me-2"></i> التواصل معنا</a><br>
                    <span><div class="footer-btn d-flex align-items-center">
                        <a class="btn btn-secondary btn-md-square me-2" href="https://www.facebook.com/thabetghazaleh?mibextid=ZbWKwL"><i class="fab fa-facebook-f text-white"></i></a>
                        <a class="btn btn-secondary btn-md-square me-2" href=""><i class="fab fa-twitter text-white"></i></a>
                        <a class="btn btn-secondary btn-md-square me-2" href=""><i class="fab fa-instagram text-white"></i></a>
                        <a class="btn btn-secondary btn-md-square me-0" href=""><i class="fab fa-linkedin-in text-white"></i></a>
                    </div></span> 
                </div>
            </div>
            <div class="col-md-6 col-lg-6 col-xl-3">
                <div class="footer-item d-flex flex-column">
                    <h4 class="text-white mb-4"></h4>
                    <a href=""><i class="fa fa-map-marker-alt me-2"></i> عمان - الأردن</a>
                    <a href=""><i class="fas fa-envelope me-2"></i> Alquds@gmail.com</a>
                    <a href=""><i class="fas fa-phone me-2"></i> +962 780781333</a>
                    <a href="" class="mb-3"><i class="fas fa-print me-2"></i> +962 779196664</a><br>
                  
                </div>
                
            </div>
            
        </div>
        
    </div>
    
  </div>
  <!-- Footer End -->
  
  
          <!-- Back to Top -->
          <a href="#" class="btn btn-secondary btn-lg-square back-to-top"><i class="fa fa-arrow-up"></i></a>   
  

          <!-- Chat Div -->
<div class="chat-icon" id="chat-icon"><i class="fa fa-comments"></i></div>
  
  <!-- نافذة الـ Chat -->
  <!-- <div class="chat-box" id="chat-box">
    <div class="chat-header">
        <h4>Messages</h4>
        <span id="close-chat" class="close-chat">&times;</span>
    </div>
    <div class="chat-body" id="chat-body">
    </div>
    <div class="chat-footer">
        <input type="text" id="chat-input" placeholder="Type a message..." />
        <button id="send-btn">Send</button>
    </div>
  </div> -->
  <script>
    // دالة لجلب بيانات المستخدم باستخدام API مع userId من localStorage
    // window.location.reload() 
    async function loadUserData() {
      const userId = localStorage.getItem('userId'); // الحصول على userId من localStorage
      const apiUrl = `https://localhost:44350/api/Users/showUserInfoByID/${userId}`; // استخدام userId في استدعاء الـ API

      try {
        const response = await fetch(apiUrl); // انتظار استجابة الـ API
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json(); // تحويل الرد إلى JSON

        // تعبئة الحقول ببيانات المستخدم
        document.getElementById('name').value = data.name || ''; // تحديث الاسم
        document.getElementById('email').value = data.email || ''; // تحديث البريد الإلكتروني
        document.getElementById('addrress').value = data.address || ''; // تحديث العنوان
        document.getElementById('phone-number').value = data.phoneNumber || ''; // تحديث رقم الهاتف
      } catch (error) {
        console.error('Error fetching user data:', error);
      }
    }

    // دالة لتعديل بيانات المستخدم وإرسالها باستخدام API
    async function submitEditProfile() {
      
      const userId = localStorage.getItem('userId');
      const apiUrl = `https://localhost:44350/api/Users/EditUserProfile/${userId}`; // استخدام EditUserProfile
    
      const userData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        address: document.getElementById('addrress').value,
        phoneNumber: document.getElementById('phone-number').value,
        // إذا كنت ترغب في تحديث كلمة المرور، يمكنك إضافة ذلك هنا
        // password: document.getElementById('password').value,
      };
    
      try {
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });
    
        if (!response.ok) {
          const errorText = await response.text(); // الحصول على نص الخطأ
          throw new Error(`Error: ${response.status} - ${errorText}`);
        }
    
        // بدلاً من محاولة تحويل الاستجابة إلى JSON، يمكنك فقط قراءة النص
        const successMessage = await response.text(); // قراءة نص الاستجابة
        alert(successMessage); // عرض رسالة النجاح
      } catch (error) {
        console.error('Error updating user profile:', error);
      }
    }
    
    // تحميل بيانات المستخدم عند تحميل الصفحة
    window.onload = loadUserData;



  
    //////////////////////////////////////////////////////////////////
  
    var userID = localStorage.getItem("UserId");
    console.log(userID);
    const url = `https://localhost:44350/api/Order/download-order/${userID}`;
  
    async function getdata() {
      const requst = await fetch(url);
      const response = await requst.json();
      console.log(response);
      var continer = document.getElementById("container");
  
      response.forEach((element) => {
        continer.innerHTML += `
   <tr>
     
        <td>${element.name}</td>
        <td>${element.amount} </td>
        <td>${element.email} </td>
        <td>${statuse(element.status)} </td>
       <td><button class="download-btn" onclick="downloadOrder(${element.orderId})">
                  <i class="fa fa-download"></i> Download
                </button></td>
    <tr>
  
        `;
      });
    }
    getdata();
    function statuse(status) {
        if (status === 0) {
          return "Pending";
        } else if (status === 1) {
          return "Delivered";
        } else {
          return "Cancelled";
        }
    }
    async function loadDownloadData(orderId) {
    try {
      
      event.preventDefault();
      const response = await fetch(`https://localhost:44350/api/Order/download-orderItems/${orderId}`);
      if (!response.ok) {
        throw new Error("Failed to fetch download data");
      }
      const data = await response.json();
      console.log(data);
  
      // Inject data into the #downloadsTable
      const tableBody = document.getElementById("downloadsTable");
      tableBody.innerHTML = ""; // Clear previous content
  
      data.forEach(item => {
        tableBody.innerHTML += `
          <tr>
            <td>${item.productName}</td>
            <td>${item.productPrice}</td>
            <td>${item.productBrand}</td>
            <td>${item.orderQuantity}</td>
            <td><a class="view">Download</a></td>
          </tr>`
        ;
      });
  
    } catch (error) {
      console.error("Error fetching download data: ", error);
    }
  }
  
  
  
  ///////////////////////////////////////////////////////////////////////////////////////
  
  async function downloadOrder(orderId) {
    
      const url = `https://localhost:44350/api/Order/GenerateInvoice?orderId=${orderId}`;
  
      const link = document.createElement("a");
      link.href = url;
      link.download = `invoice_${orderId}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    ////////////////////////////////////////////////////////////////////
  
  function smoothScrollToDownloads() {
    const downloadsSection = document.querySelector("#downloads");
    if (downloadsSection) {
      downloadsSection.scrollIntoView({ behavior: "smooth" });
    } else {
      console.error("#downloads section not found");
    }
  }

  async function loadDownloadDataAndScroll(orderId) {
    await loadDownloadData(orderId); 
    smoothScrollToDownloads(); 
  }
  
  function removeOrderTable(){
    const container = document.getElementById("orders")
    container.style.display = 'none'
  }

  </script>

          
         <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/lightbox/js/lightbox.min.js"></script>
    
    <script src="js/getCategoryOptions.js"></script>
    <!-- Template Javascript -->
    <script src="js/main.js"></script>
     <script>


async function getOrdersbyUserId(){
  const container = document.getElementById("containerorders");
  container.style.display = 'block'
  const userId =localStorage.getItem("userId")
  var url = `https://localhost:44350/api/Cart/getUserCartItems/${userId}`; // id not work  !!!!
  
  var response = await fetch(url);
  var orders = await response.json();
  console.log(orders)
 
  container.innerHTML = ""; 
  
  orders.forEach(order => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${order.product.name}</td>
        <td>${order.product.price}</td>
          <td>${order.product.priceWithDiscount}</td>
             <td>${order.quantity}</td>

      <td>Deleverd</td>
      `;
     
    container.appendChild(row);
  
}
  );
}

     </script>
  </body>
  <!-- <td><button onclick="viewOrder(${order.id})">View</button></td> -->
  </html>